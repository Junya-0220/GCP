# VPC

## 26 GoogleCloudのネットワーク

### GoogleCloudの巨大なネットワーク

google検索やGmail、YouTubeといったGoogleのサービスを支える巨大なネットワークインフラは、
毎年巨額の投資が行われており、より高いパフォーマンスを目指して日々進化を続けています。
Google Cloudのネットワークには、Googleのサービスを支えるネットワークと同じものが使用されています。
Google Cloudのネットワークには、次のような特徴があります。

* より安全により高速に

Google独自の技術によって最適化された、グローバルでハイパフォーマンスなネットワーク、安全に利用できます。

* 拡張性と柔軟性

 googleのネットワークは多くの機能が、ソフトウェアによってネットワークを定義する技術である
 SDN (Software Defined Network)よって実現されており、高い拡張性と柔軟性があります。

### Googleのネットワークサービスを理解するには

本書の内容を理解するには、リージョンを選ぶポイントを押さえておく必要があります。
多くのGoogle Cloudのサービスは、初期設定にリージョンやゾーンを指定する必要がありますが、
これは、これから解説するネットワークサービス(VPC)でも同様です。
「 エンドユーザーから物理的に最も近いリージョンはどこか」「 海外のリージョンを利用しても良いのか」といった
 内容を事前に調査して、どのリージョンゾーンでホストするのかを決める必要があります。

### GoogleCloudにおけるデフォルトの設計

google Cloudでは何らかのサービスの利用する際、いきなり高度なネットワーク設定をユーザに求める事はありません。
リソースの作成と同時に、ネットワークの設定を裏側で行ってくれるサービスがほとんどです。
ユーザがよりスピード感を持って使えるよう、また注力したい部分にコストを避けるように様々な工夫がされています。
「すぐ試したい」「まずは小さなスケールで検証したい」といった場合は、デフォルトの設定を使って作りたいシステムが実現できそうかを判断すると良いでしょう。

### まとめ

 google CloudはGmailやYouTubeと同じネットワークインフラを使用している
 googleクラウドのネットワークには、安全で拘束高い拡張性と柔軟性などの特徴がある
 ネットワークサービスを理解するには、リージョンやゾーンの理解が必須

## 27 VPC 仮想ネットワークサービス

### VPCとは

Virtual Private Cloud(VPC)は、 google Cloud内に論理的に構成された仮想ネットワークを提供するサービスです。
VPCは、 クラウド上のリソースやサービスに、グローバルなネットワーキングを提供します。
また拡張性と柔軟性に優れており、セキュアなネットワークの設定が簡単に行えます。
ここでは、VPCに用意されている機能を紹介します。
クラウドに限らず、インフラの運用経験がある人には、お馴染みの機能もあるでしょう。

* VPCの機能一覧

| サービス名 | 概要 |
| --- | --- |
| VPCネットワーク | GoogleCloud内に構成される仮想ネットワーク |
| 外部IPアドレス | 主にインターネットへのアクセスに使うIPアドレス(外部IPアドレス) |
| ファイアウォール | 接続の許可または拒否を行う |
| ルート | ルーティングの設定 |
| VPCネットワークピアリング | VPCネットワーク同士の接続 |
| 共有VPC | 異なるプロジェクトでVPCを共有 |
| サーバーレスVPCアクセス | サーバーレスなGoogleCloudサービスからのVPCへの接続 |
| パケットのミラーリング | 検査用にトラフィックのクローンを作成 |

### VPCネットワーク

VPCネットワークとは、 google Cloud内に構成される、仮想ネットワークのことです。
VPCの中心となる機能で、VPC ネットワークのことを指してVPCと呼ぶ場合もあります。
VPCネットワークは、Andromedaと 呼ばれるGoogle独自の技術を活用したネットワークです。
VPC ネットワークを使用すると、複数のサブネットをルーターで接続した、物理ネットワークと同等のグローバルネットワークが構成可能です。
なお、1つのVPCネットワークには複数のリージョンを収容できます。

<img src="image/VPC.png" alt="VPC">

### Google Cloudのコンピューティングサービスをつなぐ

VPC ネットワークは主に、コンピューティングサービスであるComputeEngineインスタンスやGoogle Kubernetes Engine(コンテナ)、
App Engineフレキシブル環境に対するネットワーキングを提供します。
仮想マシンやコンテナを作成または起動すると、作成時に紐付けられたVPCネットワークのサブネットのIPアドレスから、内部IPが自動的に割り当てられます。
この内部IPが割り当てられることで、マシン同士の通信が可能になります。
なお、VPCネットワーク内の特定の内部IPを固定的に割り当てることも可能です。

### リソース同士の通信

仮想マシン などのリソース同士は、同じVPCネットワークを使用していれば、
異なるサブネットに属していても特別なルーティングの設定なしに通信が可能です。
しかし、異なるブイPCネットワーク間で通信を行いたい場合は、VPCネットワークピアリングの設定が必要です。
(他にもクラウドVPNを使った接続方法などがあります)

### まとめ

VPCは、 google Cloudの論理的に構成された仮想ネットワークを提供するサービス
VPC ネットワークとは、Google Cloud内に構成される仮想ネットワークのこと。
同じVPC ネットワークを使用していれば、異なるサブネットに属していても特別なルーティングの設定なしに通信が可能

## 28 デフォルトネットワーク

### 「default」という名前のVPCネットワーク

Google Cloudでプロジェクトを作成すると、自動で「default」と言う名前のPCネットワーク(以下、デフォルトネットワーク)が作成されます。
デフォルトネットワークでは、あらかじめ各リージョンにサブネットが用意されています。
同じVPCネットワークに属するリソースなら、異なるサブネットの間でも特別なルーティングの設定なしに通信が可能です。
そのためデフォルトネットワークを使えばいいじゃんをまたいだグローバルの通信がすぐに行えます。
VPCを リージョンごとに作成して、各ネットワークをつなげる(ピアリングをする)といった作業は不要です。

### デフォルトネットワークなら初期設定が不要

 google Cloudのリソースの多くは、作成時にVPCネットワークを選択が必要です。
ひとまずGoogleリソースを試してみたいといった場合は、デフォルトネットワーク使用すればすぐに動作確認を始められます。
なお、リソースを作成する際は、使用するネットワーク設定を変更しない限り、デフォルトネットワーク選択されます。
ただしデフォルトネットワークは、IPアドレスが事前に割り当てられている点や、
新しいリージョンができた場合も新しいIPアドレスが自動的に割り当てられるといった点で柔軟性に欠けるので本番環境では自動でVPCネットワークを作ることをおすすめします。

## 29 サブネット

### サブネットとは

サブネットとは、あるネットワークを分割した小さなネットワークのことです。
ネットワークの分割とは、ネットワークのIPアドレスを論理的に分割することを指し、これを「サブネット化」といいます。
またサブネットは、IPアドレスのあとに「/24」といった数字を書くCIDR表記と呼ばれる方法で表記します。
この数字によって、IPアドレスの範囲を表現します。

### GoogleCloudにおけるサブネット

GoogleCloudでは、サブネットはVPCネットワーク内に定義します。
またサブネットはリージョンリソースです。リージョンリソースとは、必ずどこかのリージョンに属する必要があるリソースのことです。
つまり、サブネットは必ずどこかのリージョンを指定する必要があります。
また、サブネットは複数のゾーンに跨って使用できます。
なお、サブネットは1つのVPCネットワークに複数作成できますが、同じVPCネットワークに、IPアドレス範囲が重複するサブネットは作成できません。

### サブネットはロケーションに依存する

作成した仮想マシンなどのリソースに適用するサブネットは、リソースを利用したいロケーション(地域)と同じにするひつようがあります。
そのため、リソースを配置したいリージョンと同じリージョンに紐づくサブネットを、リソースを作成する前に用意しておく必要があります。
例えば、日本に住む人をメインターゲットにしたアプリケーションを構築する場合を考えてみましょう。
仮想マシンに保存するデータも日本に置きたい場合は、東京リージョンか大阪リージョンに事前にサブネットを作成する必要があります。
ただし、前節で紹介したデフォルトネットワークを使用すれば、各リージョンにサブネットが自動生成されているので、すぐに試すことができます。
もし、デフォルトネットワークが作成されていない場合、VPCネットワークを作成する際に、利用目的に応じてサブネットを作成するモードを選択する必要があります。

### まとめ

サブネットはVPCネットワーク内に定義する
サブネットはデータを保存したいロケーション(地域)と同じにする必要がある

## 30 VPCネットワークの2つのモード

### VPCには２つのモードがある

VPCネットワークには、各リージョンのサブネットを自動で作成する自動モードVPCネットワークと、ユーザーがサブネットの範囲を決めてカスタマイズするカスタムモードVPCネットワークがあります。
VPCネットワークを作成する際、どちらかのモードを選択する必要があります。
GoogleCloudのサービスをすぐに試したい場合は、自動モードVPCネットワークを利用すると良いでしょう。
また、本番環境構築には、カスタムモードVPCネットワークが推奨されます。
なお、一度カスタムモードVPCネットワークを選択すると、自動モードVPCには変更することはできないので注意しましょう。
自動モードVPCネットワークに変更するには、そのVPCネットワークを削除して、作り直す必要があります。

###  自動モードVPCネットワークの使い所

自動モードVPCネットワークのユースケースを紹介します。

* 各リージョンにサブネットが自動で作成されると便利な場合
自動モードにしておけば、GoogleCloudに新リージョンが追加されても、自分でサブネットを追加する手間が省けます。
* 特定のIPアドレスが必要ない場合
特定の目的でIPアドレス範囲を確保する必要がないなら、自動モードで問題ないでしょう。
* 手軽にGoogleCloudを始めてみたい場合
サブネットが自動で作成されるので、手軽にGoogle Cloudを始められます。

### カスタムVPCネットワークの使い所

カスタムVPCネットワークのユースケースを紹介します。

* 各リージョンにサブネットを自動的に割り当てる必要がない場合
特定のリージョンの見使う際は、カスタムモードにするのも1つの手です。
* 割り当てるIPアドレスの範囲を、カスタマイズする必要がある場合
高度なネットワーク設定を行いたい場合（本番環境など）には適しています。
* VPCネットワーク間を接続したい場合
自動モードVPCネットワークのように、同じIPアドレス範囲を利用しているVPC同士は接続できないため、VPCネットワーク間を接続したい場合は、カスタムモードを使用します。

### まとめ

VPCネットワークには、自動モードVPCとネットワークカスタムモードVPCがある






## 31 ファイアウォール

* ファイアウォール　ルールの項目

| 項目 | 説明 |
| --- | --- |
| 名前 | ファイアウォールルールの名前 |
| 説明 | ファイアウォールルールの説明 |
| ログ | Cloud Loggingにログを出力するかどうかを設定する |
| ネットワーク | 対象のVPCネットワーク |
| 優先度 | ほかのファイアウォールルールとの優先度 |
| トラフィックの方向 | トラフィックの上り/下り |
| 一致した時のアクション | トラフィックの許可/拒否 |
| ターゲット | ファイアウォールルールの対象範囲(すべての仮想マシン、指定されたターゲットタグ、指定されたサービスアカウント) |
| 送信元/宛先フィルタ | 特定のIPアドレス範囲にルールを適用するフィルタのこと。上りトラフィックのファイアウォールルール　ルールにはソースタグ、サービスアカウントも選択可能 |
| プロトコルとポート | ルールを設けるプロトコルとポート番号 |

* デフォルトのファイアウォールのルール

| ルール名 | ターゲット | プロトコルとポート | 概要 |
| --- | --- | --- | --- |
| default-allow-ssh | 全てに適用 | TCPポート22 | SSH接続の許可 |
| default-allow-rdp | 全てに適用 | TCPポート3389 | リモートデスクトップ接続の許可 |
| default-allow-icmp | 全てに適用 | ICMP | ICMPプロトコルの許可 |
| default-allow-internal | 全てに適用 | TCPポート0〜65535 UDPポート 0〜65535 | 内部IPに対してのルール |

## 32 VPCネットワークの拡張

