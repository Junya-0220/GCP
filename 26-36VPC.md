# VPC

## 26 GoogleCloudのネットワーク

### GoogleCloudの巨大なネットワーク

google検索やGmail、YouTubeといったGoogleのサービスを支える巨大なネットワークインフラは、
毎年巨額の投資が行われており、より高いパフォーマンスを目指して日々進化を続けています。
Google Cloudのネットワークには、Googleのサービスを支えるネットワークと同じものが使用されています。
Google Cloudのネットワークには、次のような特徴があります。

* より安全により高速に

Google独自の技術によって最適化された、グローバルでハイパフォーマンスなネットワーク、安全に利用できます。

* 拡張性と柔軟性

 googleのネットワークは多くの機能が、ソフトウェアによってネットワークを定義する技術である
 SDN (Software Defined Network)よって実現されており、高い拡張性と柔軟性があります。

### Googleのネットワークサービスを理解するには

本書の内容を理解するには、リージョンを選ぶポイントを押さえておく必要があります。
多くのGoogle Cloudのサービスは、初期設定にリージョンやゾーンを指定する必要がありますが、
これは、これから解説するネットワークサービス(VPC)でも同様です。
「 **エンドユーザーから物理的に最も近いリージョンはどこか**」「 **海外のリージョンを利用しても良いのか**」といった内容を事前に調査して、どのリージョンゾーンでホストするのかを決める必要があります。

### GoogleCloudにおけるデフォルトの設計

google Cloudでは何らかのサービスの利用する際、いきなり高度なネットワーク設定をユーザに求める事はありません。
リソースの作成と同時に、ネットワークの設定を裏側で行ってくれるサービスがほとんどです。
ユーザがよりスピード感を持って使えるよう、また注力したい部分にコストを避けるように様々な工夫がされています。
「**すぐ試したい**」「**まずは小さなスケールで検証したい**」といった場合は、デフォルトの設定を使って作りたいシステムが実現できそうかを判断すると良いでしょう。

### まとめ

* **google CloudはGmailやYouTubeと同じネットワークインフラを使用している**
* **googleクラウドのネットワークには、安全で拘束高い拡張性と柔軟性などの特徴がある**
* **ネットワークサービスを理解するには、リージョンやゾーンの理解が必須**

## 27 VPC 仮想ネットワークサービス

### VPCとは

 <span style="color:crimson; font-weight:bold;">Virtual Private Cloud(VPC)</span>は、 google Cloud内に論理的に構成された仮想ネットワークを提供するサービスです。
VPCは、 クラウド上のリソースやサービスに、グローバルなネットワーキングを提供します。
また拡張性と柔軟性に優れており、セキュアなネットワークの設定が簡単に行えます。
ここでは、VPCに用意されている機能を紹介します。
クラウドに限らず、インフラの運用経験がある人には、お馴染みの機能もあるでしょう。

* VPCの機能一覧

| サービス名 | 概要 |
| --- | --- |
| VPCネットワーク | GoogleCloud内に構成される仮想ネットワーク |
| 外部IPアドレス | 主にインターネットへのアクセスに使うIPアドレス(外部IPアドレス) |
| ファイアウォール | 接続の許可または拒否を行う |
| ルート | ルーティングの設定 |
| VPCネットワークピアリング | VPCネットワーク同士の接続 |
| 共有VPC | 異なるプロジェクトでVPCを共有 |
| サーバーレスVPCアクセス | サーバーレスなGoogleCloudサービスからのVPCへの接続 |
| パケットのミラーリング | 検査用にトラフィックのクローンを作成 |

### VPCネットワーク

 <span style="color:crimson; font-weight:bold;">VPCネットワーク</span>とは、 google Cloud内に構成される、仮想ネットワークのことです。
VPCの中心となる機能で、VPC ネットワークのことを指してVPCと呼ぶ場合もあります。
VPCネットワークは、Andromedaと 呼ばれるGoogle独自の技術を活用したネットワークです。
VPC ネットワークを使用すると、複数のサブネットをルーターで接続した、物理ネットワークと同等のグローバルネットワークが構成可能です。
なお、1つのVPCネットワークには複数のリージョンを収容できます。

<img src="image/VPC.png" alt="VPC">

### Google Cloudのコンピューティングサービスをつなぐ

VPC ネットワークは主に、コンピューティングサービスである**ComputeEngineインスタンス**や**Google Kubernetes Engine(コンテナ)**、**App Engineフレキシブル環境**に対するネットワーキングを提供します。
仮想マシンやコンテナを作成または起動すると、作成時に紐付けられたVPCネットワークのサブネットのIPアドレスから、 <span style="color:crimson; font-weight:bold;">内部IPが自動的に割り当てられます。</span>
この内部IPが割り当てられることで、マシン同士の通信が可能になります。
なお、VPCネットワーク内の特定の内部IPを固定的に割り当てることも可能です。

### リソース同士の通信

仮想マシン などのリソース同士は、同じVPCネットワークを使用していれば、
 <span style="color:crimson; font-weight:bold;">異なるサブネットに属していても特別なルーティングの設定なしに通信が可能</span>です。
しかし、異なるVPCネットワーク間で通信を行いたい場合は、**VPCネットワークピアリング**の設定が必要です。(他にもCloud VPNを使った接続方法などがあります)

### まとめ

* **VPCは、 google Cloudの論理的に構成された仮想ネットワークを提供するサービス**
* **VPC ネットワークとは、Google Cloud内に構成される仮想ネットワークのこと。**
* **同じVPC ネットワークを使用していれば、異なるサブネットに属していても特別なルーティングの設定なしに通信が可能**

## 28 デフォルトネットワーク

### 「default」という名前のVPCネットワーク

Google Cloudでプロジェクトを作成すると、自動で「<span style="color:crimson; font-weight:bold;">default</span>」と言う名前のVPCネットワーク(以下、<span style="color:crimson; font-weight:bold;">デフォルトネットワーク</span>)が作成されます。
デフォルトネットワークでは、<span style="color:crimson; font-weight:bold;">あらかじめ各リージョンにサブネットが用意されています。</span>
同じVPCネットワークに属するリソースなら、異なるサブネットの間でも特別なルーティングの設定なしに通信が可能です。
そのためデフォルトネットワークを使えば、リージョンをまたいだグローバルの通信がすぐに行えます。
VPCをリージョンごとに作成して、各ネットワークをつなげる(ピアリングをする)といった作業は不要です。

### デフォルトネットワークなら初期設定が不要

google Cloudのリソースの多くは、作成時にVPCネットワークを選択が必要です。
「ひとまずGoogleリソースを試してみたい」といった場合は、デフォルトネットワーク使用すればすぐに動作確認を始められます。
なお、リソースを作成する際は、使用するネットワーク設定を変更しない限り、デフォルトネットワーク選択されます。
ただし、デフォルトネットワークは、IPアドレスが事前に割り当てられている点や、
新しいリージョンができた場合も新しいIPアドレスが自動的に割り当てられるといった点で柔軟性に欠けるので本番環境では自動でVPCネットワークを作ることをおすすめします。

### まとめ

* **プロジェクトを作成するとデフォルトネットワークが作成される**
* **デフォルトネットワークでは、あらかじめ各リージョンにサブネットが用意されている**
* **ひとまず試したい場合は、デフォルトネットワークを使用すると良い。**

## 29 サブネット

### サブネットとは

<span style="color:crimson; font-weight:bold;">サブネット</span>とは、あるネットワークを分割した小さなネットワークのことです。
ネットワークの分割とは、ネットワークのIPアドレスを論理的に分割することを指し、これを「サブネット化」といいます。
またサブネットは、IPアドレスのあとに「/24」といった数字を書く<span style="color:crimson; font-weight:bold;">CIDR表記</span>と呼ばれる方法で表記します。
この数字によって、IPアドレスの範囲を表現します。

### GoogleCloudにおけるサブネット


GoogleCloudでは、サブネットはVPCネットワーク内に定義します。
またサブネットは<span style="color:crimson; font-weight:bold;">リージョンリソース</span>です。リージョンリソースとは、必ずどこかのリージョンに属する必要があるリソースのことです。
つまり、サブネットは必ずどこかのリージョンを指定する必要があります。
また、サブネットは複数のゾーンに跨って使用できます。
なお、サブネットは1つのVPCネットワークに複数作成できますが、同じVPCネットワークに、IPアドレス範囲が重複するサブネットは作成できません。

### サブネットはロケーションに依存する

作成した仮想マシンなどのリソースに適用するサブネットは、<span style="color:crimson; font-weight:bold;">リソースを利用したいロケーション(地域)と同じにする必要があります。</span>
そのため、リソースを配置したいリージョンと同じリージョンに紐づくサブネットを、リソースを作成する前に用意しておく必要があります。
例えば、日本に住む人をメインターゲットにしたアプリケーションを構築する場合を考えてみましょう。
仮想マシンに保存するデータも日本に置きたい場合は、東京リージョンか大阪リージョンに事前にサブネットを作成する必要があります。
ただし、前節で紹介したデフォルトネットワークを使用すれば、各リージョンにサブネットが自動生成されているので、すぐに試すことができます。
もし、デフォルトネットワークが作成されていない場合、VPCネットワークを作成する際に、利用目的に応じてサブネットを作成するモードを選択する必要があります。

### まとめ

* **サブネットはVPCネットワーク内に定義する**
* **サブネットはデータを保存したいロケーション(地域)と同じにする必要がある**

## 30 VPCネットワークの2つのモード
VPCネットワークを作成する際、サブネットを自動でさくせいするかカスタマイズするかを選べます。
目的に応じて適切な方法を選べるようになるために、それぞれの特徴やユースケースを理解しておきましょう。

### VPCには２つのモードがある



VPCネットワークには、各リージョンのサブネットを自動で作成する<span style="color:crimson; font-weight:bold;">自動モードVPCネットワーク</span>と、ユーザーがサブネットの範囲を決めてカスタマイズする<span style="color:crimson; font-weight:bold;">カスタムモードVPCネットワーク</span>があります。
VPCネットワークを作成する際、どちらかのモードを選択する必要があります。
GoogleCloudのサービスをすぐに試したい場合は、自動モードVPCネットワークを利用すると良いでしょう。
また、本番環境構築には、カスタムモードVPCネットワークが推奨されます。
なお、一度カスタムモードVPCネットワークを選択すると、自動モードVPCには変更することはできないので注意しましょう。
自動モードVPCネットワークに変更するには、そのVPCネットワークを削除して、作り直す必要があります。

| モード | 特徴 |
| --- | --- |
| 自動モードVPCネットワーク | 各リージョンのサブネットを自動で作成する |
| カスタムモードVPCネットワーク | ユーザーがサブネットの範囲を決めてカスタマイズする |


###  自動モードVPCネットワークの使い所

自動モードVPCネットワークのユースケースを紹介します。

* **各リージョンにサブネットが自動で作成されると便利な場合**
自動モードにしておけば、GoogleCloudに新リージョンが追加されても、自分でサブネットを追加する手間が省けます。
* **特定のIPアドレスが必要ない場合**
特定の目的でIPアドレス範囲を確保する必要がないなら、自動モードで問題ないでしょう。
* **手軽にGoogleCloudを始めてみたい場合**
サブネットが自動で作成されるので、手軽にGoogle Cloudを始められます。

### カスタムVPCネットワークの使い所

カスタムVPCネットワークのユースケースを紹介します。

* **各リージョンにサブネットを自動的に割り当てる必要がない場合**
特定のリージョンの見使う際は、カスタムモードにするのも1つの手です。
* **割り当てるIPアドレスの範囲を、カスタマイズする必要がある場合**
高度なネットワーク設定を行いたい場合（本番環境など）には適しています。
* **VPCネットワーク間を接続したい場合**
自動モードVPCネットワークのように、同じIPアドレス範囲を利用しているVPC同士は接続できないため、VPCネットワーク間を接続したい場合は、カスタムモードを使用します。

### まとめ

* **VPCネットワークには、自動モードVPCとネットワークカスタムモードVPCがある**

## 31 ファイアウォール
ネットワーク通信を制御するには、ファイアウォールは必須ともいえるサービスです。
GoogleCloudでも、ファイアウォールを使ってリソース間の通信制御を行えます。
ファイアウォールを設定する際の項目や、対象と紐づける方法についても解説します。

### ファイアウォールとは

 <span style="color:crimson; font-weight:bold;">ファイアウォール</span>とは、コンピュータやネットワークとの通信を、管理者などが設定したポリシーに従って、許可または拒否するセキュリティ機能のことです。
 例えば、クラウドの外からアクセスしてくるユーザーの端末と仮想マシン(ComputeEngine)間のネットワーク通信を制御できます。
 あるいは、仮想マシンや、仮想マシン上で稼働するサービス(GoogleKubernetesEngineクラスタやAppEngineフレキシブル環境など)といったリソース間のネットワーク通信を制御することもできます。
 
 ### ファイアウォール　ルール

 GoogleCloudでは、ユーザーが定義した <span style="color:crimson; font-weight:bold;">ファイアウォールルール</span>を利用して、ComputeEngineやComputeEngineといったGoogleCloudのサービスへのアクセスを制御できます。
 制御対象外のプロトコルには、TCP,UDP,ICMP,AH,ESP,SCTPなどが指定できます。
 プロトコルとは、送受信の方法やデータの表現方法といった、通信する際のルールのことです。
 なお、GoogleCloudではファイアウォールルールの有無に関係なく、外部IPアドレスのTCP25(SMTP)を宛先とする通信は許可されません。
 ファイアウォールを作成するには、次の項目を入力します。

* ファイアウォール　ルールの項目

| 項目 | 説明 |
| --- | --- |
| 名前 | ファイアウォールルールの名前 |
| 説明 | ファイアウォールルールの説明 |
| ログ | Cloud Loggingにログを出力するかどうかを設定する |
| ネットワーク | 対象のVPCネットワーク |
| 優先度 | ほかのファイアウォールルールとの優先度 |
| トラフィックの方向 | トラフィックの上り/下り |
| 一致した時のアクション | トラフィックの許可/拒否 |
| ターゲット | ファイアウォールルールの対象範囲(すべての仮想マシン、指定されたターゲットタグ、指定されたサービスアカウント) |
| 送信元/宛先フィルタ | 特定のIPアドレス範囲にルールを適用するフィルタのこと。上りトラフィックのファイアウォールルール　ルールにはソースタグ、サービスアカウントも選択可能 |
| プロトコルとポート | ルールを設けるプロトコルとポート番号 |

### ファイアウォールルールには優先度を設定できる

ファイアウォールルールは、複数設定することが可能です。
そのため、ファイアウォールルールに優先度を設定できます。
ファイアウォールルールには「まず全てのアクセスを禁止した上で、その上で必要なものを個別に許可する」という考え方があります。

### ファイアウォールルール　ルールでは上りか下りかを指定する

GoogleCloudのファイアウォールルールを作成する場合、トラフィックの上り(外部からのリソースに対してのアクセス)と下り(リソースから外部に対してのアクセス)を指定します。
送受信のそれぞれにルールを設定する場合は、上りのルールと下りのルールを別個に作成します。

### ファイアウォールルール ルールと対象の紐付け

ファイアウォールルールと対象の仮想マシンを紐づけるには、 <span style="color:crimson; font-weight:bold;">ターゲットタグ</span>を使います。
ファイアウォールルールルールで指定するターゲットタグとして、対象の仮想マシンのネットワークタグを指定することで、紐付けができます。
また、対象の仮想マシンの役割ごとにネットワークタグを用意して、ファイアウォールを使い分けることが可能です。
1つの仮想マシンに対して複数のネットワークタグが定義でき、同様にファイアウォールにおいても複数のターゲットタグを指定できます。
また、VPCネットワーク上のすべての仮想マシンに適用したり、指定のサービスアカウントに適用したりといった姉弟も可能です。

* ターゲットタグにネットワークタグを指定して紐付け

<img src="images/../image/GCP-31%20ファイアウォール.png">

### 送信元/宛先フィルタ

<span style="color:crimson; font-weight:bold;">送信元/宛先フィルタ</span>では、特定のIPアドレス範囲を送信元/宛先としたルールを適用するフィルタを設定します。
送信元/宛先のIPアドレスを指定する「IP範囲」や上りのファイアウォールルールの場合は、タグのついたソースからのトラフィックのみを許可する「ソースタグ」を指定して、設定します。

### デフォルトのファイアウォールルール

プロジェクトを作成した際に作成されるデフォルトネットワークには、デフォルトのファイアウォールルールが存在します。
このルールには、上りに対して優先度が一番低く設定された以下のルール名が存在します。

* デフォルトのファイアウォールのルール

| ルール名 | ターゲット | プロトコルとポート | 概要 |
| --- | --- | --- | --- |
| default-allow-ssh | 全てに適用 | TCPポート22 | SSH接続の許可 |
| default-allow-rdp | 全てに適用 | TCPポート3389 | リモートデスクトップ接続の許可 |
| default-allow-icmp | 全てに適用 | ICMP | ICMPプロトコルの許可 |
| default-allow-internal | 全てに適用 | TCPポート0〜65535 UDPポート 0〜65535 | 内部IPに対してのルール |

内部IP同士の通有心許可である「default-allow-internal」というファイアウォールルール以外は、任意の送信元である「0.0.0.0/0」がIP範囲として定義されます。これは広い範囲でのky他となり、セキュリティ脅威になります。
アクセスを制限するためにもユーザー自身でファイアウォールルールの定義を行い、デフォルトの定義ファイアウォールを無効化することをお勧めします。

### まとめ

* **ファイアウォールは、コンピュータやネットワークとの通信をポリシーに従って許可または拒否するセキュリティ機能**
* **ユーザーが定義したファイアウォールルールを利用してアクセス制御できる**

## 32 VPCネットワークの拡張

同じVPCネットワーク内であれば、異なるサブネットでも通信できることは解説済みです。
次は、異なるVPCネットワークを相互接続したり、VPCを共有したりする方法について、解説していきましょう。

### VPCネットワークを拡張する方法

VPCネットワークを他のネットワークとつないだり、他のプロジェクトと共有したりするには、次のサービスを使います。

* **VPCネットワークピアリング**
* **共有VPC**
* **Cloud VPN**
* **Cloud InterConnect**

### VPCネットワークピアリング

<span style="color:crimson; font-weight:bold;">VPCネットワークピアリング(以下、VPCピアリング)</span>は、2つのVPCネットワークを内部IPで接続できる方式です。たとえば、異なるプロジェクトのVPCネットワークをつなぐ場合などに使用します。
VPCネットワークが２つあるということは、論理的に２つ分かれたネットワークリソースがあるということです。
つまり、VPCピアリングやファイアウォールルールの設定は、2つのVPCネットワークで別々に管理されています。
そのため、VPCピアリングでGoogleCloudプロジェクトのリソース間を接続する場合は、互いにピアリングの設定を行う必要があります。
片方のVPCネットワークだけ設定を行っても動作しません。
そして、互いの内部IPアクセスをファイアウォールで許可すると、内部IPでアクセスできるようになります。

### VPCピアリングの特徴

VPCピアリングには次の特徴もあります。

* **ComputeEngine(仮想マシン)、GoogleKubernetesEngine(コンテナ)、AppEngienフレキシブル環境(PaaS)で動作する**

* **ピアリングされたVPCネットワーク(ファイアウォールやVPNなども含む)の管理は別々に行う**

* **1つのVPCネットワークに複数のVPCネットワークを接続出来る**

### 共有VPC
<span style="color:crimson; font-weight:bold;">共有VPC</span>とは、異なるGogle Cloud プロジェクト間でVPCを共有する機能のことです。
中央集権的にVPCを管理する<span style="color:crimson; font-weight:bold;">ホストプロジェクト</span>と、そのVPCに参加する<span style="color:crimson; font-weight:bold;">サービスプロジェクト</span>の2つが存在します。
共有VPCを使うと、1つのホストプロジェクトで複数のサービスプロジェクトを管理することが可能です。
例えば、開発環境と本番環境で、それぞれネットワークを一元的に管理するといったユースケースが考えられます。
なお、共有VPCを使用しない、今までのネットワークの例は<span style="color:crimson; font-weight:bold;">スタンドアロンVPCネットワークと呼びます。</span>

### CloudVPN

<span style="color:crimson; font-weight:bold;">CloudVPN</span>とは、GoogleCloudが提供するVPNサービスのことです、
一般的なIPsec-VPNの技術を用いて、外部のネットワークとGoogleCloud上のVPCネットワークを安全に接続できます、接続には、CloudVPNによって作成された外部IPを使用します。

### Cloud Interconnect

専用線でハイブリッドクラウドを実現するサービスに、CloudInterconnectがあります。
CloudInterconnectを用いると、オンプレミスのネットワークとGoogleCloudを、インターネットを介さずに接続できます。
GoogleCloudとオンプレミスネットワークを直接接続するDedicatedInterconnectやパートナーのサービスプロバイダを介して接続するPartnerInterconnectで構成されています。

#### Dedicated Interconnect
Dedicated Interconnectは、オンプレミスネットワークとGoogleCloudのネットワークを「直接物理的に」接続します。
そのため、高速なデータ転送を行うことが可能です。
データを転送したい場合、公共インターネットのネットワーク帯域幅を追加購入すうりょりも、コスト効率が良いです。

#### Partner Interconnect

<span style="color:crimson; font-weight:bold;">Partner Interconnect</span>は、パートナーとなっているサービスプロバイダを介して、オンプレミスとGoogleCloudのVPCネットワークを接続します。
高速に通信を行う必要のない場合や、物理的にアクセスが難しい場所にデータセンターを持っている場合などに有効です。

### まとめ

* 異なるVPCネットワークを接続するときはVPCピアリングを使用する
* プロジェクト間でVPCを共有するときは共有VPCを使用する
* 外部のネットワークとGoogleCloud上のVPCネットワークをIPsec-VPNで接続するときは、CloudVPNwo使用する
* ハイブリッド構成を実現したい場合には、CloudVPNやCloudInterconnectを使用する

## 33 ルーティングとNAT

独自のネットワークポリシーを持つ場合や、より閉鎖的なネットワークを構成する場合は、経路情報の設定やCloudNATを使用します。これらのサービスを使うと、より柔軟かつセキュアなネットワークを構築できます。

### 経路情報とは

経路情報(<span style="color:crimson; font-weight:bold;">ルーティング</span>
)は、ネットワークを構築する上で欠かせない要素です。
経路情報とは、ネットワーク上でデータを相手に届けるための宛先情報のことです。GoogleCloudでは、後述する静的ルーティングを使わなければ直接設定することはあまりないので、経路情報については概要の説明に留めます。
VPCネットワークとサブネットを構成すると<span style="color:crimson; font-weight:bold;">デフォルトルート</span>と<span style="color:crimson; font-weight:bold;">サブネットルート</span>という2種類の経路情報が自動で登録されます。デフォルトルートは、VPCネットワークからインターネットに接続する、インターネットゲートウェイへの経路情報です。サブネットルートは、サブネットワーク同士で通信するための経路情報です。

### 経路情報を設定する方法

経路情報の設定には、自動での登録以外にも方法があります。

#### 動的ルーティング

<span style="color:crimson; font-weight:bold;">動的ルーティング</span>は、CloudVPNやCloudInterconnectでオンプレミスネットワークと接続した際、動的に経路情報を交換することを指します。
VPCネットワークやオンプレミスネットワークの構成に更新があった場合も更新が動的に交換されるので、手動での経路情報の設定が不要です。

#### 静的ルーティング

<span style="color:crimson; font-weight:bold;">静的ルーティング</span>は、宛先がComputeEngineインスタンス、CloudVPN、内部ロードバランサなどになっている経路を手動で設定することを指します。
より高度なネットワーク構成を実現できますが、手動で設定が必要なため、変更の多くないネットワークで利用されます。

### CloudNAT

基本的に、<span style="color:crimson; font-weight:bold;">インターネットへのアクセスには外部IPga必要です。</span>しかし、外部からアクセスできない(インターネットに公開しない)セキュアな環境を構築するために、たとえばデータベース用のComputeEngineインスタンスなどでは、通常、外部IPを持たせません。それでも、ツールやデータのダウンロード、ソフトウェアの更新などのために、VPCネットワークからインターネットへの外向きの接続だけは許可したい場合があります。そのような際はCloudNATを使います。CloudNATは、GoogleCloudで提供されるNATサービスです。
<span style="color:crimson; font-weight:bold;">NAT(Network Address Translation)</span>とは、プライベートIPをパブリックIPに変換する技術のことです。イメージとしては、外部(インターネット)へ出るための門(ゲートウェイ)だたお考えてください。NATは、外部からのアクセスを遮断しつつ、内部からの通信を可能にします。
CloudNATを使うと、外部IPを持たないComputeEngineインスタンスやGoogleKubernetesEngineクラスタが、インターネットに向けてバケットを送受信できるようになります。

### CloudNATのメリット

CloudNATを使用するメリットには、次の点が挙げられます。

* セキュリティ

個々の仮想マシンに外部IPを割り振る必要がなくなるので、より堅牢なネットワークを構成できます。

* 可用性

単一の下相馬真也物理ゲートウェイに依存しないので、高い可用性を実現できます。

* スケーラビリティ

利用状況に応じて自動的にスケーリングするように設定でき、高いスケーラビリティとパフォーマンスを実現できます。

### Cloud NATとファイアウォールルール

NATはプライベートIPとパブリックIPを相互互換する技術です。
そのため、ファイアウォールルールを設定する際は、変換されたパブリックIPを指定すると思うかもしれませんが、必要ありません。プライベートIPに対するルールで正しく動作します。

### まとめ

* **高度にネットワークを設定する場合は、経路情報の設定やCloudNATを使用する**
* **CloudNATはGoogleCloudで提供されるNATサービス**


## 34 Cloud Load Balancing

システムの安定したパフォーマンスを実現するには、負荷分散が必要です。
GoolgleCloudでは負荷分散を行うサービスが提供されています。
負荷分散を行うと場所と使用するプロトコルによって、ロードバランサの種類は異なります。

### Cloud Load Blalancingとは

<span style="color:crimson; font-weight:bold;">Cloud Load Balancing</span>は、複数のComputeEngineやCloudStorageのバケット、マネージドサービスに対してトラフィックを負荷分散するサービスです。
複数のリージョン、複数のゾーンにまたがって負荷分散を行うこともでき、高パフォーマンス、低レイテンシを安定して提供します。
また、ユーザーやトラフィックの増加に応じて自動的にスケールするため、予期せぬアクセス数の増加が発生した場合も対応できます。
自動スケーリングはプレウォーミング(事前のスケーリング)などは不要で、トラフィックがゼロの状態からフル稼働の状態まで、数秒でスケールが行われます。
CloudLoadBalancingは、インターネットからのトラフィックを負荷分散する<span style="color:crimson; font-weight:bold;">外部負荷分散</span>と、VPCネットワーク内部でのトラフィックを負荷分散する<span style="color:crimson; font-weight:bold;">内部負荷分散</span>に分類することが出来ます。

### ロードバランサの種類

Cloud Load Balancingは、外部負荷分散と内部負荷分散だけではなく、使用できるプロトコルによっても分類されます。

* ロードバランサの種類

| ロードバランサの種類 | 概要 |
| --- | --- |
| 内部HTTP(S)負荷分散 | VPCネットワーク内で内部IPを使用して特定のリージョン内でアクセスすることができるレイヤ7のロードバランサ。<br>ComputeEngineやGoogleKubernetesEngineでホストされているバックエンドに対してHTTP/HTTPSトラフィックを分散する |
| 外部HTTP(S)負荷分散 | 外部IPを使用してインターネットアクセスできるレイヤ７ロードバランサ。<br>ComputeEngineやGoogleKubernetesEngineでホストされているバックエンドに対してHTTP/HTTPSトラフィックを分散する。<br>複数リージョンをまたいでトラフィックを分散できる。 |
| 内部TCP/UDP負荷分散 | VPCネットワーク内で内部IPを使用してアクセスできるロードバランサ。<br>TCPまたはUDPトラフィックを分散できる。 |
| 外部TCP/UDP負荷分散 | 外部IPを使用してインターネットアクセスできるリージョンのパススルーロードバランサ。<br>同じリージョン内のComputeEngineなどにTCPまたはUDPトラフィックを分散できる。 |
| 外部SSLプロキシとTCPプロキシ負荷分散 | インターネットから送信されたSSL/TCPトラフィックをロードバランサで終端して、<br>VPCネットワーク内の最も近いバックエンドインスタンスに複数リージョンをまたいでトラフィックを分散する |

その中でも使用頻度が高い、外部HTTP(S)負荷分散と、外部TCP/UDPネットワーク負荷分散についても解説します。

### 外部HTTP(S)負荷分散

<span style="color:crimson; font-weight:bold;">外部HTTP(S)負荷分散</span>は、Webブラウザなどの端末からWebアプリケー所にアクセスする際、もしくは、WebAPIへアクセスする際に使用するHTTP/HTTPSプロトコル専用のロードバランサです。複数のリージョンやゾーンにまたがった負荷分散に対応しており、アクセス元のクライアントからリージョンにアクセスを振り分けることが出来ます。
Webプロキシ―として動作する仕組みになっているので、ComputeEngineのインスタンスなどで稼働するバックエンドのアプリケーションは、ロードバランサが使用する特定範囲のIPアドレスからリクエストを受け取ります。
なお、ストリーミングやネイティブアプリなどで、HTTP/HTTPS以外のプロトコルを使用する必要がある際は、この次に説明する外部TCP/UDPネットワーク負荷分散を使用します。

### 外部TCP/UDPネットワーク負荷分散

<span style="color:crimson; font-weight:bold;">外部TCP/UDPネットワーク負荷分散</span>は、UDPもしくはTCPプロトコルによる一般的な通信を負荷分散します。
リージョンごとに作成するロードバランサを用いて、同じリージョン内で負荷分散を行います。外部HTTP(S)負荷分散とは異なり、プロキシ―としての機能は持たず、クライアントからのリクエストをそのままの形で、バックエンドのアプリケーションに転送します、
また、アプリケーションからの応答バケットは、ロードバランサを介さずに、直接クライアントに送信されます。
HTTP/HTTPSプロトコルにアクセスの場合も、外部TCP/UDPネットワーク負荷分散を使用することが出来ます。
しかしSSL証明書による認証など、HTTPSプロトコルに特有の機能は提供されないので注意が必要です。

### まとめ

* **CloudLoadBlancingはトラフィックの負荷分散機能を提供する。**

## 35 CloudCDN

GoogleCloudでは、CDNコンテンツサービスも提供されています。
Googleのグローバルネットワークを利用してコンテンツを配信するもので、世界中のどこにいてもWebコンテンツの表示速度を向上させることが出来ます。


### CDNとは

<span style="color:crimson; font-weight:bold;">CDN(Content Delivery Network)</span>とは、Webコンテンツの配信を高速化する仕組みのことです。CDNでは、キャッシュサーバーに画像やHTMLファイルといった静的ファイルのキャッシュを配置します。
ユーザーからのアクセスに対して、もともとのコンテンツを持つサーバー(オリジンサーバー)ではなく、キャッシュサーバーがコンテンツを配信します。
サーバーとユーザーの物理的な距離が近くなるため、コンテンツの読み込みが高速になります。

### CloudCDNとは
<span style="color:crimson; font-weight:bold;">CloudCDN</span>とは、GoogleCloudで提供されているCDNサービスの事です。
コンテンツの配信をGoogleのグローバルネットワークを利用して行います。
CloudCDNはすぐに利用できます。
外部HTTP(S)負荷分散(HTTP(S)ロードバランサ)を設定して、オリジンサーバー(インスタンスグループや、Cloud Storageバケット、ネットワークエンドポイントグループなど)を構成すれば、すぐに有効化できます。

### CloudCDNのメリット

CloudCDNを利用するメリットは次の点が上げられます。

* **サーバーが処理するべきアクセスをCDNが代替するため、負荷が軽減する**
* **ユーザーに物理的に近いCDNからコンテンツを配信するので、WEBさいとの表示速度が改善する**

### CloudCDNのデメリット

* **オリジンサーバーでのWeb解析ツールに、アクセス結果が反映されない。ただし、HTTP(S)ロードバランサーのログにはCloudCDNのアクセスも含むので、それでアクセス分析はできる。**
* **更新頻度の高いコンテンツをキャッシュさせないなど、コンテンツの性質に合わせたキャッシュ管理が必要になる**

### CloudCDNのキャッシュモードの種類

CloudCDNでは、次のキャッシュモードが存在します。
なお、キャッシュの有効期間はユーザーが設定することが出来ます。

#### 静的コンテンツをキャッシュする

「静的コンテンツをキャッシュする」は、CloudCDNのデフォルトの設定です。
privateやno-store,no-chacheといったディレクティブで明示的にキャッシュを拒否するコンテンツを除き、すべての静的コンテンツをキャッシュします。
有効期間(TTL)の設定だけで利用でき、送信元の変更は特に必要ありません。

#### Cache-Controlヘッダーに基づいて送信元の設定を使用する

「Cache-Controlヘッダーに基づいて送信元の設定を使用する」は、送信元であるオリジンサーバーで設定したCache-Controlヘッダーに基づいてキャッシュします。
利用するにあたり、送信元でヘッダーの設定が必要です。

#### すべてのコンテンツを強制的にキャッシュする

「すべてのコンテンツを強制的にキャッシュする」はprivateやno-store,no-cacheといったディレクティブを無視し、送信元から提供されるコンテンツをすべてキャッシュします。

### まとめ
* **GoogleCloudのCDNサービスとしてCloudCDNが存在している。**






