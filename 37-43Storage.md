# ストレージサービス「クラウドストレージ」

## 37CloudStorage

###  CloudStorageとは
<span style="color:crimson; font-weight:bold;">CloudStorage</span>は、データの容量が無制限で、耐久性が高いストレージサービスです。
GoogleCloudの数あるサービスの中でも、10年以上の歴史があるサービスです。
CloudStorageは、もともとはGoogleが公開しているGoogleCodelabsというサービス内で、2010年5月にGoogleStorageforDevelopersという名称で一般公開されたのでした。
その後、2011年10月に「GoogleCloudStorage」という名称で、正式なサービスとして提供が開始されました。
CloudStorageは、各種データのバックアップやアーカイブ、ComputeEngineの複数インスタンスからアクセスするための共有ストレージとしてなど、幅広い用途で利用可能です。またデータ分析でも分析用の未加工のデータを蓄積する場所としてよく使います。

### CloudStorageはオブジェクトストレージサービス

CloudStorageは安全で信頼性の高い<span style="color:crimson; font-weight:bold;">オブジェクトストレージサービス</span>です。
オブジェクトストレージとは、データを「オブジェクト」と呼ばれる単位で管理するストレージのことです。
ここでいうオブジェクトは、一般的なファイルと考えて差し支えないでしょう。
オブジェクトは「バケット」と呼ばれる入れ物に格納されます。

### CloudStorageの特徴

CloudStorageには次のような特徴があります。

#### データ容量が無制限

データ容量が無制限です。アップロードするデータサイズの下限もありません。
(0byteのオブジェクトを作成することが可能)。また、バケット内に格納するオブジェクト数にも制限がありません。ミニマムでスタートでき、容量を気にせずに保存できます。
ただし、１つのオブジェクトのサイズは最大５Bになります。

#### 非常に高い耐久性

99.999999999(イレブンナイン)の耐久性があります。また構成によって異なりますが、99.0％～99.95%の可用性がSLAとして提示されています。
なお可用性とは、サービスや障害やエラーなどがなく稼働できる度合いの事です。

#### データを保存できる


データのアップロードやダウンロードを行う際に、ネットワーク経路を暗号化するTLS(Transport Layer Security)で接続するため、安全に転送出来ます。
また、保存されるデータもデフォルトで暗号化されます。さらに、<span style="color:crimson; font-weight:bold;">バケットロック</span>と呼ばれる、バケットのデータを保護する機能を活用すると、オブジェクトの変更を制限することも可能です。
なお、バケット作成時にデータを格納するロケーションとしてマルチリージョンあるいは、デュアルリージョンのオプションを選択すると、複数の地域でデータが冗長化されます。

#### 柔軟かつ容易なアクセス管理


<span style="color:crimson; font-weight:bold;">Identity and Access Managment(IAM)</span>を使うと、CloudStorageリソースに対して柔軟なアクセス管理が簡単に出来ます。
また、「きめ細かい管理」として呼ばれる機能を使うと、個々のバケットやオブジェクトに対してアクセス制御することも可能です。

#### 低レイテンシでアクセスできる

どのストレージクラス(ストレージの種類の事)のオブジェクトも低レイテンシでアクセス出来ます。
ストレージクラスは、データへのアクセス頻度によって使い分けることが出来ますが、<span style="color:crimson; font-weight:bold;">利用するストレージクラスによってレスポンス速度が急激に下がるといったことがありません。</span>
つまり、オンプレミスのテープ装置のように、アーカイブデータを取り出すのに長時間待たされるといった不便さはありません。

#### 豊富なアクセス方法


Cloud Storageへのアクセス方法は、いくつでも用意されています。
GoogleCloudコンソールやRESTAPI、gsutilコマンド(CLI)、各種言語に対応したライブラリといった方法があるので、用途によって最適な方法を選択できます。
なお、ストレージクラスが異なっていてもAPIの内容は同じなので、<span style="color:crimson; font-weight:bold;">一貫した方法でアクセス可能です。</span>

### 料金体系

CloudStorageでは、ストレージ、オペレーション、ネットワークそれぞれに、料金がかかります。

* CloudStorageの料金

#### ストレージ料金

ストレージ料金は、バケットに格納されているデータの量で決定されます。
ストレージクラスとバケットのリージョンによって料金は変わります。

#### オペレーション料金

オペレーション料金は、CloudStorageで実行した操作(オブジェクトのダウンロードなどの回数によって決定されます。無料の操作もあります。

#### ネットワーク料金

ネットワーク料金は、バケットから読み取ったデータ量、又はバケット間で移動したデータ量によって決定されます。上り(外部からGoogleCloudへ転送)の料金は無料です。

### まとめ

* **CloudStorageは、データ容量が無制限で、耐久性が高いオブジェクトストレージサービスのことです。**


## CloudStorageを使う流れ

CloudStorageにデータを保存するには、バケットを作成する必要があります。
また、CloudStorageを操作する方法はいくつか種類があるので、それぞれの特徴を理解しておきましょう。

### CloudStorageを使う流れ

バケットの作成やオブジェクトのアップロードといった<span style="color:crimson; font-weight:bold;">基本的な操作は、GoogleCloudコンソールで行います。</span>
CloudStorageを使う際は、まずバケットを作成します。
作成したバケットに尾笛句とをアップロードするには、GoogleCloudコンソールを使えば、ドラッグアンドドロップで可能です。
なお、オブジェクトのストレージクラスを変更するなど一部の操作については、Googleコンソール上では操作出来ません。

### CloudStorageを操作できるツール

CloudStorageを操作する方法は、GoogleCloudコンソール以外に、ターミナルから利用する<span style="color:crimson; font-weight:bold;">gsutilコマンド(CLI)</span>
もあります。
GoogleCloudの多くのサービスではgcloudコマンドを使用したくなりますが、CloudStorageは、gsutilコマンドを使うことになるので、注意してください。
繰り返し作業を行う際や、大量のオブジェクトをアップロード・ダウンロードする際は、gsutilコマンドを使った方が便利です。
そのほかにも、オブジェクトのアップロードやダウンロード操作をより使いやすくするツールとして、GoogleCloudのCloudStorageTransferServiceやサードパーティーのツールを活用出来ます。
手元の端末上にファイルがあるかのように操作できるツールもあるので、用途に合わせて使い分けましょう。

* Cloud Storageを操作できるツール

| ツール名 | 内容 |
| --- | --- |
| GoogleCloudコンソール | Webブラウザでデータを管理するためのGUIが用意されている。<br>ドラッグアンドドロップで操作が可能。 |
| gsutil | CloudStorageを操作するためのコマンドラインツール |
| クライアントライブラリ | 任意のプログラミング言語で、(C++,C#,Go,Java,Node.js,PHP,Python,Rubyなど)を使用してデータを管理できる |
| RESTAPI | JSONまたはXMLAPIを使用してデータを管理できる |


### まとめ

* **CloudStorageにデータを保存するには、バケットを作成をする必要があります。**
* **CloudStorageはGoogleCloudコンソールで操作可能です。**
* **CloudStorageを操作する方法は、GoogleCloudコンソール以外にもgsutilコマンド(CLI)などがあります。**

## 39 ストレージクラス

CloudStorageには４つのクラスがあり、それぞれ可用性や料金が異なります。
ワークロードに応じて使い分けることで、パフォーマンスには影響なくコストを抑えることが出来ます。

### ストレージクラスとは

CloudStorageでは、ストレージの種類によってデータの保存や取得、操作にかかる料金や可用性が異なります。
この種類の事をストレージクラスと呼びます。ストレージクラスには次の4種類があります。

Standard storage
Nearline storage
Coldline storage
Archive storage
高可用性が求められるデータには、Standard Storageを使用します。
価格は高くなりますが、4種類の中で一番可用性が提供されます。
アクセス頻度が低く、やや低い可用性でも許容できるデータはNearline StorageやClodlineStorage、Archive Storageを使用します。
これらは、バックアップやアーカイブデータの格納に向いています。
また、StandardStorage以外は最低保持期間が決められており、それより速く削除をしても最低保持期間分保存したと仮定した料金がかかります。

* ストレージクラスの種類

ストレージクラスにはそれぞれワークロードに応じて適切なものを選択する必要があります。

| ストレージクラス | 概要 |
| --- | --- |
| Standard Storage | Webサイトやストリーミング動画など、アクセス頻度が高い「ホット」なデータの格納に適している。<br>高可用性が求められる場合にも向いている。 |
| Nearline Storage | Standard Storageよりも低料金のクラス。最小保持期間が30日のため、30日以上保持する必要のあるデータで、<br>月に一度程度アクセスする場合のデータの保持に向いている |
| Coldline Storage | ストレージ料金は非常に低い。少なくとも90日以上は保存されるため、数カ月に1回程度アクセスするデータ<br>(障害復旧用のデータなど)に適している |
| Archive Storage | 4つのクラスの中で、ストレージ料金が一番低い。各種規制・法令に関するアーカイブなど、<br>少なくとも365日間保存する必要があるデータに向いている。<br>オペレーション料金は他のクラスに比べて低い |


### 早期削除料金とは

早期削除料金は、早期にデータを削除した時に適用されるストレージ料金です。
オブジェクトを削除する時に、保存聞かgンが所定の日数以下の場合、実際に所定の日数保存したとして計算されるので注意しましょう。
たとえば、Nearline Storageの所定日数は30日ですが、アップロードから1日後に削除下としても、30日間保存したのと同じ分だけの料金がかかります。

### まとめ

* **ストレージクラスはストレージの種類の事です。**
* **ストレージクラスはワークロードに応じて適切なものを選択する必要があります。**

## 40オブジェクトとバケット

ここでは、Cloud Storageにおけるオブジェクトとバケットについて解説します。あまり馴染みのない言葉かもしれませんが、CloudStorageを理解するのに重要な用語です。

### オブジェクトとバケット

CloudStorageにおけるオブジェクトとは、<span style="color:crimson; font-weight:bold;">オブジェクトデータ</span>と<span style="color:crimson; font-weight:bold;">オブジェクトメタデータ</span>という2つのコンポーネントで考査英されています。オブジェクトデータは通常、CloudStorageに保存するファイルのことです。
オブジェクトメタデータは、オブジェクトの様々な性質を記述した名前と値のペアの集合です。
なお、オブジェクトにはサイズの上限がありますが、１バケット内に保存できるオブジェクトの数に上限はありません。
CloudStorage内に保存するオブジェクトはすべて、バケットに格納する必要があります。
バケットは、オブジェクトの整理やアクセス制御に使用します。
なお、ディレクトリやフォルダとは異なり、バケットの中にバケットを作成することはできませんが、ファイル名を「/」記号で区切るとフォルダに相当する機能を使用することができます。たとえば、「gs://my-buket/my-folder/file.txt」といいう名前のファイルが作成されます。その際、GoogleCloudコンソールの画面上では、「my-folder」というフォルダ内に「file.txt」というファイルがあるかのように表示されます。

### バケットの作成

CloudStorageを使うには、まずバケットを作成する必要があります。
バケットの作成には、<span style="color:crimson; font-weight:bold;">バケット名</span>や<span style="color:crimson; font-weight:bold;">リージョン</span>、<span style="color:crimson; font-weight:bold;">ストレージクラス</span>の指定が必要です。

### バケット名のルール

バケット名のルールは、次のようになっています。

* **バケット名に使用できる文字は、アルファベットの小文字、数字、ダッシュ、アンダースコア、ドット**
* **先頭と末尾は、数字かアルファベットにする必要がある**
* **長さは3〜63文字**
* **バケット名の先頭に「goog」は使用できない**
* **バケット名に「google」や「google」に類似する表記は含められない**

また、バケット名はグローバルでユニークである必要があります。
プロジェクトが異なっていたとしても、同じ名前のバケットは作成できません。
なお、バケットは、用途やアクセス制限の種類、配置するリージョンなどによって分けることがほとんどです。どのようなデータをアップロードするのかを考え、必要に応じて作成しましょう。

### バケットやオブジェクトの名前に注意

Google Storageへアクセスする際は、バケット名とオブジェクト名を指定します。
そのため、第三者がアクセスし、エラーレスポンスからバケットやオブジェクトの存在を確認できます。たとえば、新製品の名前をバケット名に使用していて、そこから未発表の製品の名前が漏れるという可能性もあります。一般公開しないバケットは推測されにくい名称を用いて、機密情報を含めないようにしましょう。

### バケットのリージョン

バケットの作成時に指定するリージョンは、ユーザーやアプリケーションに最も近いリージョンにします。
日本国内からの利用であれば、asia-northeast1リージョン(東京)かasia-northeast2リージョン(大阪)を選べば問題ないでしょう。
また、データを地理的に冗長化したい場合は、<span style="color:crimson; font-weight:bold;">マルチリージョン</span>あるいは<span style="color:crimson; font-weight:bold;">デュアルリージョン</span>を指定します。
マルチリージョンの場合は、決められたエリア内のデータセンターのうちいくつかにデータが配置されます。
デュアルリージョンの場合は、特定の2つのリージョンで冗長化されます。
デュアルリージョンは配置するリージョンが把握できるため、データの近くにワークロードを置く可能性があります。

* マルチリージョン

| マルチリージョン名 | 説明 |
| --- | --- |
| ASIA | アジア内のデータセンター |
| EU | 欧州連合の加盟国内データセンター |
| US | 米国内のデータセンター |

* デュアルリージョン

| デュアルリージョン | 説明 |
| --- | --- |
| asia1 | asia-northeast1(東京)とasia-northeast2(大阪) |
| eur4 | europe-north1(フィンランド)とeuroupe-west4(オランダ) |
| nam4 | us-central1(アイオワ)とus-east1(サウスカロライナ) |


### バケットロック

バケットには、バケット内のオブジェクトの保持期間を制御するデータ<span style="color:crimson; font-weight:bold;">(保存ポリシー)</span>を構成できます。<span style="color:crimson; font-weight:bold;">バケットロック</span>という機能は、この保持ポリシーを変更できないようにする機能です。バケットロックを使用すると、保持期間が終了するまで、そのオブジェクトを削除できなくなります。

### まとめ

* **オブジェクトは、オブジェクトデータとオブジェクトメタデータで構成されている**
* **バケットの作成には、バケット名、リージョン、ストレージクラスの指定が必要**
* **バケットロックは、保持ポリシーを変更できないようにする機能**


## 41 アクセス制限

CloudStorageに保存するデータの中には、機密性が高いものもあるでしょう。
その場合、そのデータへのアクセスを制御したいケースがあります。
ここでは、CloudStorageのアクセス管理について学びましょう。

### アクセス管理の方法

アクセス制限には、IAM(Identity and Access Management)を使った<span style="color:crimson; font-weight:bold;">均一なバケットレベルのアクセス</span>と、IAMとACL(Access Control Lists)を併用した<span style="color:crimson; font-weight:bold;">きめ細かい管理</span>の２種類があります。一見すると「均一なアクセス管理」より「きめ細かい管理」ができた方がいいと考えることが多いと思いますが、「きめ細かい管理」は管理が複雑になるので、設定ミスの可能性が高くなります。そのため、原則としては「均一なバケットレベルでのアクセス」のみでアクセス制限を行うことが推奨されています。

### 均一なバケットレベルのアクセス(推奨)

「均一なバケットレベルのアクセス」はIAMのみを使用して制限を管理する方式です。
IAMを使うと、バケット内のすべてのオブジェクト、あるいは、共通の名前の接頭辞を持つオブジェクトのグループに権限を適用できます。
個人を特定できる情報など、機密性の高いデータを含むオブジェクトがある場合は、権限の管理が容易な「均一なバケットレベルのアクセス」を有効にしたバケットにデータを保管するといいでしょう。
CloudStorgaeのアクセス制御のために事前定義されたIAMロールがあるので、それをユーザーあるいはGoogleグループに付与します。
事前定義されたロールだけでは管理しづらい場合は、カスタムロールを定義することもできます。

### きめ細かい管理

「きめ細かい管理」を使うと、IAMとACL(Access Control Lists)を併用し権限管理できます。ACLとは、AWSのストレージサービスであるAmazon S3と、互いにやりとりできること目的に設計されたシステムのことです。「きめ細かい管理」は、バケットレベルとオブジェクトレベルの両方で、アクセス権限を指定できます。そのsため、オブジェクトごとに権限を設定したい場合など、複雑な権限設定が必要な場合に利用します。
ただし、その管理も複雑になるので、注意が必要です。基本的には、前述の「均一なレベルのアクセス」を使用することをおすすめします。

### まとめ

* **アクセスの方法は「均一なバケットレベルのアクセス」と「きめ細かい管理」の２種類がある**
* **「均一なバケットレベルのアクセス」のほうが簡単に管理できて、設定ミスの心配が少ない**

## 42 おぶじぇくとのアップロードとダウンロード

CloudStorageのオブジェクトのアップロードとダウンロードには、さまざまな方法が提供されています。扱うファイルのサイズやエラー発生時の対応などに、それぞれ特徴があります。

### オブジェクトのアップロード

CloudStorageへのオブジェクトをアップロードする方法には、いくつか種類があります。
ファイルのサイズや、アップロード失敗時に再開可能にするかどうかといった観点で、適切な方法を選択します。また、アプリケーションからのアップロード時には、ストリーミングも利用できます。

* アップロードの種類

| アップロードの種類 | 概要 |
| --- | --- |
| 単一のリクエストのアップロード | ファイルのサイズが小さく、接続エラーの発生時にファイル全体の再アップロードが可能な場合に使用する。<br>エラー発生時は最初からやり直す必要がある。転送途中の状態からアップロードの再開はできない。 |
| マルチパートアップロード | AWSのストレージサービスであるAmazon S3と互換性のあるアップロード方法 |
| 再開可能なアップロード | 信頼性の高い転送を行う場合に使用する。特に、ファイルサイズが大きい場合に使用する。<br>アップロードごとに１つもHTTPリクエストを送信するので、サイズの小さなファイルでも利用できる。<br>再開可能なアップロードとしてストリーミング転送の使用も可能。 |
| 並列複合アップロード | 1つのファイルが最大で32チャンク(データの断片)に分割され、これらのチャンクが並列して一時オブジェクトにアップロードされる。<br>オブジェクトのサイズが大きい時に特に効果的 |
| ストリーミングアップロード | プロセス(アプリケーション)からアップロードを生成する場合や、状況に応じてオブジェクトを圧縮する場合など、アップロードの開始時に最終的なサイズがわからないデータをアップロードする際に使用する。 |

### オブジェクトのダウンロード

CloudStorageからオブジェクトをダウンロードする方法にも、いくつか種類があります。
ファイルのサイズやダウンロードを再開可能にするかどうかといった観点で、適した方法を選択します。

* ダウンロードの種類

| ダウンロードの種類 | 概要 |
| --- | --- |
| シンプルダウンロード | オブジェクトを宛先にダウンロードする |
| ストリーミングダウンロード | オブジェクトをプロセス(アプリケーション)にダウンロードする |
| スライス化されたオブジェクトのダウンロード | オブジェクトをチャンクに分けて並列でダウンロードする |
| 認証によるWebブラウザでのダウンロード | Googleアカウントで認証してWebブラウザからダウンロードする |

なお、１つのオブジェクトをアップロードまたはダウンロードする場合に、「並列複合アップロード」や「スライス貸されたオブジェクトのダウンロード」を使うと、オブジェクトがチャンクに分かれて並列で処理され、処理が完了したら1つのオブジェクトになります。そのため、ファイルサイズが大きい時にはこれらの方法が便利です。

### マルチスレッド、マルチ処理を利用したアップロード・ダウンロード

gsutilコマンドを利用すると、複数のオブジェクトをアップロードまたはダウンロードする際に、マルチスレッド、マルチ処理で複数のファイルを同時に転送できます。
最適なスレッド数・プロセス数は、ネットワーク速度やCPUの数、使用可能なメモリなど、さまざまな要因によって異なります。

### 各ツールで可能な動作

オブジェクトのアップロード・ダウンロードはGoogleコンソール、gsutilコマンド、各種クライアントアプリ、RESTAPIで行えます。それぞれのツールで対応している、アップロードとダウンロードの種類は異なります。

| ツール | アップロード | ダウンロード |
| --- | --- | --- |
| GoogleCloudコンソール | 自動的に管理される「再開可能なアップロード」機能を備えた、「単一のリクエストのアップロード」 | シンプルダウンロード、認証によるWebブラウザでのダウンロード |
| gsutilコマンド | 自動的に管理される「再開可能なアップロード」機能を備えた「単一リクエストのアップロード」、<br>並列複合アップロード、ストリーミングアップロード | シンプルダウンロード、ストリーミングダウンロード、スライス化されたオブジェクトのダウンロード |
| クライアントライブラリ | プログラミング言語によって異なる | プログラミング言語によって異なる |
| REST API | 単一リクエストのアップロード、マルチパートアップロード、再開可能なアップロード、ストリーミングアップロード | シンプルダウンロード、ストリーミングダウンロード |


### まとめ

* **オブジェクトのアップロードとダウンロードには種類があるので、要件にあったものを選択する**
* **各ツールで対応しているアップロードとダウンロードの種類は異なる**

## 43 バージョニングとライフサイクル管理

CloudStorageには、バージョン機能や、オブジェクトの自動削除などができるライフサイクル管理の機能も備わっています。これらの機能を有効活用すれば、ストレージにかかる料金を最適化できます。

### バージョニング
<span style="color:crimson; font-weight:bold;">バージョニング</span>とは、オブジェクトを削除または上書きする際に過去バージョン(現行バージョン以外の履歴すべてのこと)の子ポーを保持することです。バージョニングを設定しておけば、誤ってオブジェクトを上書き、あるいは削除してしまっても、過去のバージョンを指定して復元できます。なお、<span style="color:crimson; font-weight:bold;">バージョニングの設定はバケットに対して行うものであり、オブジェクトに対して個別に設定するものではありません。</span>

### ライフサイクル
<span style="color:crimson; font-weight:bold;">ライフサイクル管理</span>は、バケットに対するアクションを、定期的に実行したり日付指定で実行したりできる機能です。ライフサイクル管理を使うと、バージョニングで必要な世代分だけを保持したり、より低料金なストレージクラスへ自動的に変更したりすることもできます。
なお、ライフサイクル管理もバケットに対して設定するものであり、オブジェクトに対して個別に設定することはできません。
具体的なユースケースは次のようなものがあります。

* **アップロードから90日以上経過したオブジェクトのストレージクラスを、低料金なColdlineStorageに変更する**
* **特定の日付より前に作成されたオブジェクトを削除する**
* **バージョニングが有効になっているバケット内の各オブジェクトで、全部で３世代分のみを保持する**

### ライフサイクルでオブジェクトに対して可能な操作

ライフサイクル操作には、DeleteアクションとSetStorageClassアクションという2つのアクションがあります。Deleteアクションを指定すると、ライフサイクル管理で指定したすべての条件を満たした時に、オブジェクトが削除されます。

<span style="color:crimson; font-weight:bold;">SetStorageClassアクション</span>を指定すると、ライフサイクル管理で指定されたすべての条件を満たした時に、オブジェクトのストレージクラスが変更されます。

なお、SetStorageClassアクションでできるストレージクラスは、元のストレージクラスによって異なります。

### まとめ

* **バージョニングとは、オブジェクトを削除または上書きする際に過去のバージョンのコピーを使うこと**
* **ライフサイクル管理を使うと、バージョニングで必要な世代分だけを保持することが可能**
* 


